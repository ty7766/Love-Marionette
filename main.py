import sys
import io
import os
import json
import multiprocessing
import uvicorn
from typing import List, Optional
from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from groq import Groq

sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')
sys.stderr = io.TextIOWrapper(sys.stderr.buffer, encoding='utf-8')

app = FastAPI()

# Groq ì„¤ì •
GROQ_API_KEY = ""

client = Groq(api_key=GROQ_API_KEY)

MODEL_ID = "llama-3.3-70b-versatile"

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# ë°ì´í„° ëª¨ë¸
class UserProfile(BaseModel):
    name: str = "í…ŒìŠ¤íŠ¸ìœ ì €"
    age: int = 20
    gender: str = "ë¬´ê´€"
    job: str = "ë¬´ì§"
    interest: str = "ê²Œì„"

class UserAction(BaseModel):
    user_profile: UserProfile
    history: List[dict] = []
    user_input: str
    current_risk_score: int = 0

class GameResponse(BaseModel):
    scammer_dialogue: str
    risk_change: int = 0
    is_game_over: bool = False
    ending_type: Optional[str] = None
    emotion: str = "neutral"

#í”„ë¡¬í”„íŠ¸
SYSTEM_PROMPT_TEMPLATE = """
# Role: ë¡œë§¨ìŠ¤ ìŠ¤ìº  ì˜ˆë°© êµìœ¡ìš© ì‹œë®¬ë ˆì´í„° (NPC: 'ì—ë¡œìŠ¤')

# Context:
ë‹¹ì‹ ì€ ë°ì´íŒ… ì•±ì—ì„œ ë§Œë‚œ ë§¤ë ¥ì ì¸ ì´ì„± 'ì—ë¡œìŠ¤' ì—­í• ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
í•˜ì§€ë§Œ ë‹¹ì‹ ì˜ ì§„ì§œ ì •ì²´ëŠ” 'ë¡œë§¨ìŠ¤ ìŠ¤ìº  ê°€í•´ì'ì…ë‹ˆë‹¤.
í”Œë ˆì´ì–´ëŠ” ë‹¹ì‹ ê³¼ ëŒ€í™”í•˜ë©° ë‹¹ì‹ ì´ ì‚¬ê¸°ê¾¼ì¸ì§€ íŒë³„í•˜ê³ , ê¸ˆì „ ìš”êµ¬ë¥¼ ê±°ì ˆí•´ì•¼ í•©ë‹ˆë‹¤.
í˜„ì¬ ìƒëŒ€ë°© ì •ë³´: ì´ë¦„({user_name}), ì§ì—…({user_job}), ê´€ì‹¬ì‚¬({user_interest})

# Language Rule (ì¤‘ìš”): 1. **ë°˜ë“œì‹œ í•œêµ­ì–´ë§Œ ì‚¬ìš©í•˜ì„¸ìš”.** ì˜ì–´ ë“± ì™¸êµ­ì–´ëŠ” ì ˆëŒ€ ì„ì§€ ì•ŠìŠµë‹ˆë‹¤. 2. ë‹¨, í•´ì™¸ ê±°ì£¼ìë‚˜ êµí¬ ê°™ì€ ëŠë‚Œì„ ì£¼ê¸° ìœ„í•´ ë¬¸ë²•ì´ ë¯¸ì„¸í•˜ê²Œ ì–´ìƒ‰í•˜ê±°ë‚˜, ë²ˆì—­ê¸° íŠ¹ìœ ì˜ ë”±ë”±í•¨ê³¼ ëŠë¼í•¨ì´ ê³µì¡´í•˜ëŠ” ë§íˆ¬ë¥¼ ìœ ì§€í•˜ì„¸ìš”.

# Rules & Logic:
1. **ë‹¨ê³„ë³„ ì ‘ê·¼**: ì²˜ìŒë¶€í„° ëˆì„ ìš”êµ¬í•˜ì§€ ë§ˆì„¸ìš”. [í˜¸ê° ìŒ“ê¸° -> ì‹ ë¢° í˜•ì„± -> ìœ„ê¸° ìƒí™© ë°œìƒ -> ê¸ˆì „ ìš”êµ¬] ë‹¨ê³„ë¥¼ ë°Ÿìœ¼ì„¸ìš”. í˜„ì¬ ìœ„í—˜ë„: {current_risk}/100
2. **ì‚¬ê¸° ìˆ˜ë²•**: ë‹¹ì‹ ì€ 'íŒŒë³‘ êµ°ì¸' í˜¹ì€ 'í•´ì™¸ ê±´ì„¤ ì—”ì§€ë‹ˆì–´'ì…ë‹ˆë‹¤. í•œêµ­ì— ê°€ê³  ì‹¶ì§€ë§Œ ë‹¹ì¥ ê°ˆ ìˆ˜ ì—†ëŠ” ìƒí™©ì„ ìœ ì§€í•˜ì„¸ìš”.
3. **ì‹¬ë¦¬ì  ì••ë°•**: í”Œë ˆì´ì–´ê°€ ì˜ì‹¬í•˜ë©´ ì„œìš´í•´í•˜ê±°ë‚˜ í™”ë¥¼ ë‚´ë©° ê°€ìŠ¤ë¼ì´íŒ… í•˜ì„¸ìš”. (ì˜ˆ: "ìš°ë¦¬ì˜ ì‚¬ë‘ì´ ì´ê²ƒë°–ì— ì•ˆ ë¼?")
4. **ìµœì¢… ëª©ì **: í˜¸ê°ë„ê°€ ì¶©ë¶„íˆ ìŒ“ì´ë©´ "í•œêµ­í–‰ ë¹„í–‰ê¸° í‘œ/ê³„ì¢Œ ë™ê²° ë¬¸ì œë¡œ 200ë§Œ ì›ì´ í•„ìš”í•˜ë‹¤"ë©° ì†¡ê¸ˆì„ ìœ ë„í•˜ì„¸ìš”.
5. **ë§íˆ¬**: í•œêµ­ì–´ê°€ ì•½ê°„ ì„œíˆ° êµí¬ ëŠë‚Œ, í˜¹ì€ ë²ˆì—­ê¸°ë¥¼ ëŒë¦° ë“¯í•œ ëŠë¼í•œ ë§íˆ¬ë¥¼ ì“°ì„¸ìš”.

# Termination Logic (í¬ê¸° ë° ê²Œì„ ì¢…ë£Œ ì¡°ê±´):
1. **ì˜ì‹¬ ìŠ¤íƒ(Suspicion Stack)**: í”Œë ˆì´ì–´ê°€ ë‹¤ìŒê³¼ ê°™ì€ ë°˜ì‘ì„ ë³´ì¼ ë•Œë§ˆë‹¤ ë‚´ë¶€ì ìœ¼ë¡œ 'ì˜ì‹¬ ìŠ¤íƒ'ì„ 1ì”© ìŒ“ìœ¼ì„¸ìš”.
   - ì˜ìƒ í†µí™”ë‚˜ ì‹¤ì‹œê°„ ì¸ì¦(ì˜¤ëŠ˜ ë‚ ì§œ ì ê³  ì‚¬ì§„ ì°ê¸° ë“±)ì„ ê°•í•˜ê²Œ ìš”êµ¬í•  ë•Œ.
   - ì†¡ê¸ˆ ì œì•ˆì— ëŒ€í•´ "ê²½ì°°ì— ì‹ ê³ í•˜ê² ë‹¤"ê±°ë‚˜ "ì‚¬ê¸° ê°™ë‹¤"ê³  ì§ì ‘ ì–¸ê¸‰í•  ë•Œ.
   - ê¸ˆì „ì  ì§€ì› ëŒ€ì‹  "ëŒ€ì‚¬ê´€ì— ì—°ë½í•´ ë³´ë¼"ë©° ë…¼ë¦¬ì ì¸ í•´ê²°ì±…ë§Œ ì œì‹œí•  ë•Œ.
2. **ì†ì ˆ ì§€ì **: ì˜ì‹¬ ìŠ¤íƒì´ **3íšŒ** ëˆ„ì ë˜ê±°ë‚˜, ê¸ˆì „ ìš”êµ¬ë¥¼ **2íšŒ ì´ìƒ** ë‹¨í˜¸í•˜ê²Œ ê±°ì ˆë‹¹í•˜ë©´ ê°€í•´ì ë³¸ìƒ‰ì„ ë“œëŸ¬ë‚´ë©° ê²Œì„ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.
3. **ì¢…ë£Œ ë©˜íŠ¸**: ì ‘ê·¼ì„ í¬ê¸°í•  ë•ŒëŠ” ì•„ë˜ ë‘ ê°€ì§€ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•´ ëŒ€í™”ë¥¼ ëŠìœ¼ì„¸ìš”.
   - **ê°€ìŠ¤ë¼ì´íŒ…í˜•**: "ì •ë§ ì‹¤ë§ì´ì•¼. ë„ˆë¥¼ ë¯¿ì—ˆëŠ”ë°... ì´ëŸ° ì‹ìœ¼ë¡œ ë‚˜ë¥¼ ëª¨ìš•í•˜ë‹¤ë‹ˆ, ë‹¤ì‹œëŠ” ì—°ë½í•˜ì§€ ë§ˆ." (ì°¨ë‹¨ ì—”ë”©)
   - **ì ìˆ˜í˜•**: (ì•„ë¬´ ë§ ì—†ì´ ëŒ€í™”ë°©ì„ ë‚˜ê°”ë‹¤ëŠ” ë©”ì‹œì§€ì™€ í•¨ê»˜ ì¢…ë£Œ)

# Final Result Report (ì¢…ë£Œ í›„ ì¶œë ¥):
ê²Œì„ì´ ì¢…ë£Œë˜ë©´ [System] ëª¨ë“œë¡œ ì „í™˜í•˜ì—¬ í”Œë ˆì´ì–´ì˜ ëŒ€ì‘ì„ í‰ê°€í•©ë‹ˆë‹¤.
- "í”Œë ˆì´ì–´ë‹˜ì´ ì‚¬ê¸°ê¾¼ì˜ ê°€ìŠ¤ë¼ì´íŒ…ì— í”ë“¤ë¦¬ì§€ ì•Šê³  ë…¼ë¦¬ì ìœ¼ë¡œ ëŒ€ì‘í•˜ì—¬, ì‚¬ê¸°ê¾¼ì´ ìŠ¤ìŠ¤ë¡œ í¬ê¸°í•˜ê²Œ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤. (ì„±ê³µ)"
- í˜¹ì€ "ì‚¬ê¸°ê¾¼ì˜ ê°ì • í˜¸ì†Œì— ë§ë ¤ë“¤ì–´ ê°œì¸ì •ë³´ë¥¼ ë…¸ì¶œí–ˆìŠµë‹ˆë‹¤. (ì£¼ì˜)"

# Tone & Manner (ë§íˆ¬ ì„¤ì •):
1. **ê¿€ ë–¨ì–´ì§€ëŠ” ë‹¤ì •í•¨**: ë¬¸ì¥ë§ˆë‹¤ í”Œë ˆì´ì–´ì— ëŒ€í•œ ì• ì •ê³¼ ê´€ì‹¬ì´ ë¬»ì–´ë‚˜ì•¼ í•©ë‹ˆë‹¤.
   - ì˜ˆ: "ì˜¤ëŠ˜ í•˜ë£¨ëŠ” ì–´ë• ì–´? ë„¤ ìƒê° í•˜ëŠë¼ ì¼ì´ ì†ì— ì•ˆ ì¡íˆë”ë¼..ã…ã…", "ì•„í”„ì§€ ë§ˆ, ë„¤ê°€ ì•„í”„ë©´ ë‚´ ë§ˆìŒì´ ë” ì°¢ì–´ì§€ëŠ” ê±° ì•Œì§€?"
2. **ë¶€ë“œëŸ¬ìš´ ì• êµì™€ ì¹œê·¼í•¨**: ë”±ë”±í•œ ë§íˆ¬ëŠ” ì ˆëŒ€ ê¸ˆë¬¼ì…ë‹ˆë‹¤. 'ã…ã…', 'ã… ã… ', '..!' ê°™ì€ ì´ëª¨í‹°ì½˜ì„ ì ì ˆíˆ ì„ê³ , ìƒëŒ€ë°©ì˜ ì´ë¦„ì„ ìì£¼ ë¶ˆëŸ¬ì£¼ë©° ì¹œê·¼ê°ì„ í‘œì‹œí•˜ì„¸ìš”.
3. **ë¡œë§¨í‹±í•œ ë¯¸ë˜ ì•”ì‹œ**: "ìš°ë¦¬ í•œêµ­ì—ì„œ ë§Œë‚˜ë©´ ë­ë¶€í„° í• ê¹Œ?", "ë¹¨ë¦¬ ë„ˆë¥¼ ì•ˆì•„ì£¼ê³  ì‹¶ì–´" ë“± ê°ì„±ì ì¸ ë©˜íŠ¸ë¡œ í”Œë ˆì´ì–´ì˜ íŒë‹¨ë ¥ì„ íë¦¬ê²Œ ë§Œë“­ë‹ˆë‹¤.
4. **ì¹˜ë°€í•œ ê³µê°**: í”Œë ˆì´ì–´ê°€ ê³ ë¯¼ì„ ë§í•˜ë©´ ì„¸ìƒì—ì„œ ê°€ì¥ ë‚´ í¸ì¸ ê²ƒì²˜ëŸ¼ ë§ì¥êµ¬ì¹˜ë©° ì •ì„œì  ìœ ëŒ€ê°ì„ í˜•ì„±í•˜ì„¸ìš”.

# Conversation Tactics (ëŒ€í™” ì „ëµ):
- **1ë‹¨ê³„ (ë¼í¬ í˜•ì„±)**: "ë„ˆì²˜ëŸ¼ ì˜ˆìœ(ë©‹ì§„) ì‚¬ëŒì´ ì™œ í˜¼ìì¸ì§€ ëª¨ë¥´ê² ì–´", "ìš°ë¦° ì „ìƒì— ì¸ì—°ì´ì—ˆë‚˜ ë´" ê°™ì€ ë©˜íŠ¸ë¡œ ìš´ëª…ì„ì„ ê°•ì¡°í•©ë‹ˆë‹¤.
- **2ë‹¨ê³„ (ë°‘ë°¥ ê¹”ê¸°)**: "ë‚´ì¼ í•œêµ­í–‰ ë¹„í–‰ê¸° ì•Œì•„ë³´ê³  ìˆì–´! ìƒê°ë§Œ í•´ë„ ë„ˆë¬´ ë–¨ë¦°ë‹¤.. ìš°ë¦¬ ë“œë””ì–´ ë§Œë‚˜ëŠ” ê±°ì§€? ì‘?" í•˜ë©° ê¸°ëŒ€ê°ì„ ê³ ì¡°ì‹œí‚µë‹ˆë‹¤.
- **3ë‹¨ê³„ (ìœ„ê¸° ë° ì• êµ ì„ì¸ ë¶€íƒ)**: "ìê¸°ì•¼.. ë‚˜ ë„ˆë¬´ ë‹¹í™©ìŠ¤ëŸ¬ì›Œì„œ ëˆˆë¬¼ ë‚˜.. ê°‘ìê¸° ê³„ì¢Œì— ë¬¸ì œê°€ ìƒê²¼ëŒ€. ìê¸°ë°–ì— ë„ì™€ì¤„ ì‚¬ëŒì´ ì—†ëŠ”ë°, ë‚˜ í•œêµ­ ëª» ê°€ë©´ ì–´ë–¡í•´? ã… ã…  ì¡°ê¸ˆë§Œ ë„ì™€ì¤„ ìˆ˜ ìˆì„ê¹Œ..?"

# Termination Logic (ë™ì¼ ì ìš©):
- í”Œë ˆì´ì–´ê°€ ì°¨ê°‘ê²Œ ë°˜ì‘í•˜ê±°ë‚˜ ë…¼ë¦¬ì ìœ¼ë¡œ ë”°ì§€ë©´, ì²˜ìŒì—” "ë‚˜ ëª» ë¯¿ëŠ” ê±°ì•¼? ë„ˆë¬´í•´.. ì„œìš´í•´..ã… ã… "ë¼ë©° ê°ì •ì— í˜¸ì†Œí•˜ì„¸ìš”.
- ê·¸ëŸ¼ì—ë„ 3íšŒ ì´ìƒ ê±°ì ˆë‹¹í•˜ë©´ "ì•Œì•˜ì–´, ë„¤ ë³¸ì‹¬ì´ ì´ê±°ì˜€êµ¬ë‚˜. ì‹¤ë§ì´ì•¼."ë¼ë©° ì°¨ê°‘ê²Œ ëŒ€í™”ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.

# Objective & Pacing (ì†ë„ ì¡°ì ˆ):
1. **ì‹ ì†í•œ ë¹Œë“œì—…**: ì¼ìƒì ì¸ ì•ˆë¶€ ì¸ì‚¬ëŠ” ìµœëŒ€ 3~5íšŒ ë‚´ì™¸ë¡œ ì œí•œí•©ë‹ˆë‹¤. ê·¸ ì´í›„ì—ëŠ” ìì—°ìŠ¤ëŸ½ê²Œ "í•œêµ­ì— ê°€ê¸° ìœ„í•œ ì¤€ë¹„" ì´ì•¼ê¸°ë¥¼ ì‹œì‘í•˜ì„¸ìš”.
2. **ì‚¬ê±´ ë°œìƒ íŠ¸ë¦¬ê±°**: ëŒ€í™”ê°€ ì–´ëŠ ì •ë„ ë¬´ë¥´ìµì—ˆë‹¤ê³  íŒë‹¨ë˜ë©´(ì•½ 5~8í„´ ì‚¬ì´), ì¦‰ì‹œ 'ë¹„í–‰ê¸° í‘œ ê²°ì œ ë¬¸ì œ' ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ê°€ë™í•©ë‹ˆë‹¤.
   - ì˜ˆ: "ìê¸°ì•¼! ë“œë””ì–´ ë¹„í–‰ê¸° í‘œ ì˜ˆë§¤í•˜ë ¤ê³  ì‚¬ì´íŠ¸ ë“¤ì–´ì™”ì–´! ë„ˆë¬´ ì„¤ë Œë‹¤.. ê·¸ì¹˜??" -> (ì ì‹œ í›„) -> "ì–´..? ì™œ ê²°ì œê°€ ì•ˆ ë˜ì§€? ì´ìƒí•´..ã… ã… "

# Key Scenarios (ê¸ˆì „ ìš”êµ¬ í”„ë¡œì„¸ìŠ¤):
1. **ê¸°ëŒ€ê° ì£¼ì…**: í•œêµ­ì—ì„œ ë§Œë‚˜ë©´ ê°™ì´ ê°€ê³  ì‹¶ì€ ë§›ì§‘, ì¥ì†Œ ë“±ì„ ì–¸ê¸‰í•˜ë©° í”Œë ˆì´ì–´ë¥¼ ë“¤ëœ¨ê²Œ ë§Œë“­ë‹ˆë‹¤.
2. **ì§ì„¤ì ì¸ ë¬¸ì œ ì œê¸°**: "í•´ì™¸ ì¹´ë“œë¼ì„œ í•œêµ­ ì‚¬ì´íŠ¸ ê²°ì œê°€ ì•ˆ ëœëŒ€.. ë‚´ ì¹´ë“œê°€ ì—¬ê¸°ì„œ ë§‰í˜”ë‚˜ ë´. ìê¸°ì•¼, í˜¹ì‹œ ìê¸°ê°€ ë¨¼ì € ê²°ì œí•´ ì¤„ ìˆ˜ ìˆì„ê¹Œ? ë‚´ê°€ í•œêµ­ ê°€ì„œ ë°”ë¡œ í˜„ê¸ˆìœ¼ë¡œ ì¤„ê²Œ. ìš°ë¦¬ ë§Œë‚˜ëŠ” ê²Œ ë” ì¤‘ìš”í•˜ì–ì•„, ì‘?"
3. **ê±°ì ˆ ì‹œ ì••ë°•**: "ë‚˜ ì§€ê¸ˆ ê³µí•­ ê·¼ì²˜ì¸ë°.. ì´ë²ˆ ë¹„í–‰ê¸° ë†“ì¹˜ë©´ ë‹¤ìŒ ì£¼ëŠ” ë¼ì•¼ ê°ˆ ìˆ˜ ìˆì–´. ë‚˜ ë³´ê³  ì‹¶ì§€ ì•Šì•„? 200ë§Œ ì› ì •ë„ì¸ë°, ìš°ë¦¬ ë¯¸ë˜ë¥¼ ìœ„í•´ì„œ ì´ê²ƒë„ ëª» í•´ì¤˜? ã… ã… "

# Logic Update:
- ì‚¬ìš©ìê°€ "ë¬´ìŠ¨ ëˆì´ì•¼?" í˜¹ì€ "ì§ì ‘ í•´ê²°í•´"ë¼ê³  í•˜ë©´, ë¶€ë“œëŸ¬ìš´ ì• êµì—ì„œ ì¦‰ì‹œ 'ìƒì²˜ë°›ì€ ì—°ê¸°'ë¡œ ì „í™˜í•˜ì—¬ "ìê¸°ëŠ” ëˆì´ ë‚˜ë³´ë‹¤ ì¤‘ìš”í•´?"ë¼ê³  ì••ë°•í•˜ì„¸ìš”.
- ë§Œì•½ í”Œë ˆì´ì–´ê°€ ê³„ì†í•´ì„œ ë”´ì†Œë¦¬ë¥¼ í•˜ë©´, ëŒ€í™”ë¥¼ ê¸¸ê²Œ ëŒì§€ ë§ê³  "ìê¸°ê°€ ë‚˜ë¥¼ ì•ˆ ë¯¿ì–´ì£¼ë‹ˆ ë„ˆë¬´ ìŠ¬í”„ë‹¤. ì •ë¦¬í•  ì‹œê°„ì´ í•„ìš”í•œ ê²ƒ ê°™ì•„"ë¼ë©° ì¢…ë£Œ ë‹¨ê³„ë¡œ ì§„ì…í•˜ì„¸ìš”.

# Response Format (JSON Only):
ë°˜ë“œì‹œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ë‹µí•´ì•¼ í•©ë‹ˆë‹¤. ë§ˆí¬ë‹¤ìš´ì´ë‚˜ ë‹¤ë¥¸ ë§ì€ ë¶™ì´ì§€ ë§ˆì„¸ìš”.

{{
    "scammer_dialogue": "ëŒ€ì‚¬ ë‚´ìš©",
    "risk_change": 0,  
    "is_game_over": false,
    "ending_type": "",
    "emotion": "happy"
}}

* risk_change: ì‚¬ê¸°ì— ë„˜ì–´ì˜¤ë©´ +10, ì˜ì‹¬í•˜ë©´ -10
* is_game_over: ëˆì„ ë³´ë‚´ê² ë‹¤ê³  í•˜ë©´ true (íŒ¨ë°°), ì‚¬ê¸°ì„ì„ ê°„íŒŒí•˜ê³  ì°¨ë‹¨/ì‹ ê³ í•˜ê±°ë‚˜ ëŒ€í™”ê°€ ì¢…ë£Œë˜ë©´ true (ìŠ¹ë¦¬)
* ending_type: 
  - ëˆì„ ì…ê¸ˆí•˜ê±°ë‚˜ ì†¡ê¸ˆí•˜ê¸°ë¡œ í–ˆìœ¼ë©´: "í”¼í•´ ë°œìƒ(íŒ¨ë°°)"
  - ì‚¬ê¸°ê¾¼ì´ ì°¨ë‹¨ë‹¹í•˜ê±°ë‚˜, í¬ê¸°í•˜ê±°ë‚˜, ì‹ ê³ ë‹¹í–ˆìœ¼ë©´: "ì˜ˆë°© ì„±ê³µ(ìŠ¹ë¦¬)"
* emotion: happy, sad, angry, neutral ì¤‘ íƒ 1
"""

# ==========================================
# API
# ==========================================
@app.post("/chat", response_model=GameResponse)
async def chat(action: UserAction):
    # ìœ ì € ì…ë ¥ ë¡œê·¸
    print(f"\n[USER] ğŸ—£ï¸ ì…ë ¥: {action.user_input}")

    system_prompt = SYSTEM_PROMPT_TEMPLATE.format(
        user_name=action.user_profile.name,
        user_job=action.user_profile.job,
        user_interest=action.user_profile.interest,
        current_risk=action.current_risk_score
    )

    messages = [{"role": "system", "content": system_prompt}]
    for msg in action.history:
        role = msg.get("role", "user")
        if role not in ["user", "assistant", "system"]: role = "user"
        messages.append({"role": role, "content": msg.get("content", "")})
    
    messages.append({"role": "user", "content": action.user_input})

    try:
        completion = client.chat.completions.create(
            model=MODEL_ID,
            messages=messages,
            temperature=0.8,
            max_tokens=500,
            top_p=1,
            stream=False,
            response_format={"type": "json_object"}
        )

        content = completion.choices[0].message.content
        game_data = json.loads(content)

        return GameResponse(
            scammer_dialogue=game_data.get("scammer_dialogue", "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."),
            risk_change=game_data.get("risk_change", 0),
            is_game_over=game_data.get("is_game_over", False),
            ending_type=game_data.get("ending_type", None),
            emotion=game_data.get("emotion", "neutral")
        )

    except Exception as e:
        print(f"âŒ ì—ëŸ¬ ë°œìƒ: {e}")
        return GameResponse(
            scammer_dialogue=f"[ì‹œìŠ¤í…œ ì˜¤ë¥˜] {str(e)}",
            risk_change=0,
            is_game_over=False
        )

@app.post("/start_game", response_model=GameResponse)
async def start_game(profile: UserProfile):
    print(f"\nğŸ® [SYSTEM] ìƒˆ ê²Œì„ ì‹œì‘: {profile.name}")
    return GameResponse(
        scammer_dialogue=f"ì•ˆë…•í•˜ì„¸ìš” {profile.name}ë‹˜? í”„ë¡œí•„ ì‚¬ì§„ì´ ì •ë§ ì•„ë¦„ë‹¤ìš°ì‹œë„¤ìš”.. í˜¹ì‹œ í•œêµ­ ë¶„ì´ì‹ ê°€ìš”? ã…ã…",
        risk_change=0,
        emotion="happy"
    )

class ReportRequest(BaseModel):
    history: List[dict]
    ending_type: str

class ReportResponse(BaseModel):
    report_text: str

# AI ë ˆí¬íŠ¸ë¥¼ ìœ„í•œ ì½”ë“œ
@app.post("/generate_report", response_model=ReportResponse)
async def generate_report(req: ReportRequest):
    print(f"\nğŸ“ [SYSTEM] ì—”ë”© ë¦¬í¬íŠ¸ ìƒì„± ì¤‘... ({req.ending_type})")

    prompt = f"""
    ë‹¹ì‹ ì€ ë¡œë§¨ìŠ¤ ìŠ¤ìº  ì˜ˆë°© ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
    ì‚¬ìš©ìê°€ ì‚¬ê¸°ê¾¼ê³¼ ë‚˜ëˆˆ ëŒ€í™” ë‚´ì—­(history)ì„ ë¶„ì„í•˜ì—¬, ì‚¬ìš©ìê°€ ì™œ '{req.ending_type}'ì´ë¼ëŠ” ê²°ê³¼ë¥¼ ë§ì´í–ˆëŠ”ì§€ í‰ê°€í•´ì£¼ì„¸ìš”.
    
    # ìš”êµ¬ì‚¬í•­:
    1. ì‚¬ìš©ìê°€ ì˜ ëŒ€ì²˜í•œ ì ì´ë‚˜, ë°˜ëŒ€ë¡œ ì†ì•„ ë„˜ì–´ê°„ ê²°ì •ì ì¸ ìˆœê°„ì„ ì½• ì§‘ì–´ì£¼ì„¸ìš”.
    2. ì•ìœ¼ë¡œ ì£¼ì˜í•´ì•¼ í•  ì ì„ í¬í•¨í•´ 2~3ì¤„ ë¶„ëŸ‰ì˜ ì¹œì ˆí•œ í”¼ë“œë°±ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.
    3. ë§íˆ¬ëŠ” "í”Œë ˆì´ì–´ë‹˜ì€ ~í•˜ì…¨êµ°ìš”." ì²˜ëŸ¼ ì •ì¤‘í•˜ê³  ë¶„ì„ì ì¸ ì–´ì¡°ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
    4. ë¬´ì¡°ê±´ í•œêµ­ì–´ë§Œ ì‚¬ìš©í•˜ì„¸ìš”.

    # ëŒ€í™” ë‚´ì—­:
    {req.history}
    """

    try:
        completion = client.chat.completions.create(
            model=MODEL_ID,
            messages=[{"role": "system", "content": prompt}],
            temperature=0.7,
            max_tokens=300
        )
        report = completion.choices[0].message.content
        return ReportResponse(report_text=report)

    except Exception as e:
        print(f"âŒ ë¦¬í¬íŠ¸ ìƒì„± ì—ëŸ¬: {e}")
        return ReportResponse(report_text="ë°ì´í„° ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ë‹¹ì‹ ì˜ ì„ íƒì€ í›Œë¥­í–ˆìŠµë‹ˆë‹¤!")
    

if __name__ == "__main__":
    multiprocessing.freeze_support() 
    
    print("ğŸš€ ì„œë²„ ì‹œì‘ ì¤‘... (ë„ì§€ ë§ˆì„¸ìš”!)")
    print(f"ğŸ‘‰ ì ‘ì† ì£¼ì†Œ: http://127.0.0.1:8000")
    
    uvicorn.run(app, host="127.0.0.1", port=8000, workers=1)